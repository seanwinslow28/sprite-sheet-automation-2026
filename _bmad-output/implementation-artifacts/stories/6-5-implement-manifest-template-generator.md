# Story 6.5: Implement Manifest Template Generator

Status: done

---

## Story

**As an** operator,
**I want** to create manifests from templates for new characters/moves,
**So that** I can quickly configure new pipeline runs.

---

## Acceptance Criteria

### Template Generation

1. **CLI command** - Run `pipeline new-manifest --character NOVA --move attack` ‚úÖ
2. **Output location** - New manifest file created at `manifests/nova-attack.yaml` ‚úÖ
3. **Required sections** - Manifest includes all required sections with placeholder values ‚úÖ
4. **Inline comments** - Includes comments explaining each field ‚úÖ
5. **Example values** - References example values from the schema ‚úÖ
6. **Schema validation** - Generated manifest passes schema validation ‚úÖ

---

## Tasks / Subtasks

- [x] **Task 1: Create new-manifest command** (AC: #1)
  - [x] 1.1: Create `src/commands/new-manifest.ts`
  - [x] 1.2: Accept `--character` and `--move` flags
  - [x] 1.3: Accept optional `--output` for custom path
  - [x] 1.4: Validate character/move names

- [x] **Task 2: Create manifest template** (AC: #3, #4, #5)
  - [x] 2.1: Create `assets/templates/manifest.yaml.template`
  - [x] 2.2: Include all required sections
  - [x] 2.3: Add explanatory comments for each field
  - [x] 2.4: Include example values

- [x] **Task 3: Implement template engine** (AC: #2, #3)
  - [x] 3.1: Load template file
  - [x] 3.2: Replace placeholders: `{{CHARACTER}}`, `{{MOVE}}`
  - [x] 3.3: Generate output path from character/move
  - [x] 3.4: Handle name sanitization (lowercase, underscores)

- [x] **Task 4: Implement file writing** (AC: #2)
  - [x] 4.1: Check if manifests folder exists
  - [x] 4.2: Check if target file already exists
  - [x] 4.3: Handle overwrite with --force flag
  - [x] 4.4: Write file with proper permissions

- [x] **Task 5: Implement schema validation** (AC: #6)
  - [x] 5.1: Parse generated manifest
  - [x] 5.2: Validate against Zod schema
  - [x] 5.3: Report any validation errors
  - [x] 5.4: Ensure template always produces valid manifest

- [x] **Task 6: Add preset options** (AC: #3)
  - [x] 6.1: Add `--preset` flag (champion, boss, npc)
  - [x] 6.2: Champion preset: 128px, standard thresholds
  - [x] 6.3: Boss preset: 256px, relaxed thresholds
  - [x] 6.4: Apply preset values to template

- [x] **Task 7: Write tests** (AC: all)
  - [x] 7.1: Test manifest generated with correct name
  - [x] 7.2: Test placeholders replaced correctly
  - [x] 7.3: Test generated manifest passes validation
  - [x] 7.4: Test preset values applied

---

## Dev Notes

### Command Signature

```bash
pipeline new-manifest [options]

Options:
  --character, -c <name>    Character name (required)
  --move, -m <name>         Move name (required)
  --output, -o <path>       Custom output path
  --preset, -p <type>       Preset type: champion, boss, npc (default: champion)
  --force, -f               Overwrite existing file
```

### Manifest Template (manifest.yaml.template)

```yaml
# Manifest for {{CHARACTER}} - {{MOVE}}
# Generated by: pipeline new-manifest
# Date: {{DATE}}

# ============================================================================
# IDENTITY - Who is this and what are they doing?
# ============================================================================
identity:
  character: "{{CHARACTER}}"     # Character ID (e.g., BLAZE, NOVA)
  move: "{{MOVE}}"               # Move ID (e.g., idle_standard, walk_forward)
  version: "v1"                  # Version for tracking changes
  frame_count: 8                 # Total frames in animation
  is_loop: true                  # Does animation loop? (idle, walk = true)
  move_type: "idle"              # idle, walk, attack, jump, block, hit

# ============================================================================
# INPUTS - Reference images for generation
# ============================================================================
inputs:
  # REQUIRED: The anchor/identity image (frame 0 reference)
  anchor: "assets/characters/{{CHARACTER_LOWER}}/anchor.png"

  # OPTIONAL: Style reference images (up to 6)
  style_refs:
    - "assets/characters/{{CHARACTER_LOWER}}/style_ref_1.png"
    # - "assets/characters/{{CHARACTER_LOWER}}/style_ref_2.png"

  # OPTIONAL: Pose reference images
  pose_refs: []

  # OPTIONAL: Color palette (hex codes or image)
  palette: "assets/characters/{{CHARACTER_LOWER}}/palette.png"

  # OPTIONAL: Grid overlay guides
  guides:
    - "assets/guides/guide_{{TARGET_SIZE}}.png"

# ============================================================================
# GENERATOR - AI generation settings
# ============================================================================
generator:
  backend: "gemini"              # AI backend (gemini is only option for MVP)
  model: "gemini-2.0-flash-exp"  # Model ID
  mode: "edit"                   # edit (from reference) or generate

  # Sampling parameters (Deep Think Lock - do not change temperature!)
  temperature: 1.0               # MUST be 1.0 - lower causes mode collapse
  top_p: 0.95
  top_k: 40

  # Seed policy
  seed_policy: "deterministic_then_random"  # First attempt uses seed, retries randomize
  max_attempts_per_frame: 5                 # Max retries per frame

  # Prompt templates (paths to files or inline)
  prompts:
    master: "assets/prompts/{{CHARACTER_LOWER}}/master.txt"
    variation: "assets/prompts/{{CHARACTER_LOWER}}/variation.txt"
    lock: "assets/prompts/shared/lock.txt"
    negative: "assets/prompts/shared/negative.txt"

# ============================================================================
# CANVAS - Frame dimensions and alignment
# ============================================================================
canvas:
  generation_size: 512           # AI generates at this size
  target_size: {{TARGET_SIZE}}   # Final output size (128 or 256)
  downsample_method: "nearest"   # Always nearest for pixel art

  alignment:
    method: "contact_patch"      # contact_patch, center, or none
    vertical_lock: true          # Lock baseline to anchor
    root_zone_ratio: 0.15        # Bottom 15% for root detection
    max_shift_x: 32              # Safety clamp for horizontal shift

# ============================================================================
# AUDITOR - Quality gate thresholds
# ============================================================================
auditor:
  thresholds:
    identity_min: 0.80           # SSIM minimum (0.0-1.0)
    palette_min: 0.75            # Palette fidelity minimum
    alpha_artifact_max: 0.10     # Max alpha halo severity
    baseline_drift_max: 3        # Max baseline drift in pixels
    composite_min: 0.70          # Composite score minimum
    orphan_pixel_max: 15         # Max orphan pixels before soft fail

  weights:
    stability: 0.35
    identity: 0.30
    palette: 0.20
    style: 0.15

# ============================================================================
# RETRY - Failure recovery settings
# ============================================================================
retry:
  stop_conditions:
    max_retry_rate: 0.50         # Stop if >50% frames need retries
    max_reject_rate: 0.30        # Stop if >30% frames rejected
    max_consecutive_fails: 3     # Stop after 3 consecutive failures

  # Custom reason-to-action mapping (optional, uses defaults if omitted)
  # ladder:
  #   SF01_IDENTITY_DRIFT: ["identity_rescue", "re_anchor"]
  #   SF02_PALETTE_DRIFT: ["tighten_negative"]

# ============================================================================
# TRANSPARENCY - Alpha channel handling
# ============================================================================
transparency:
  strategy: "true_alpha"         # true_alpha or chroma_key
  chroma_color: "auto"           # auto, #FF00FF, #00FF00, etc.

# ============================================================================
# EXPORT - Atlas output settings
# ============================================================================
export:
  atlas_format: "phaser"         # Only phaser supported in MVP
  output_path: null              # Custom output path (null = runs/{id}/export/)
  packer_flags: []               # Additional TexturePacker flags (locked flags cannot be overridden)
```

### Presets

```typescript
const PRESETS = {
  champion: {
    target_size: 128,
    frame_count: 8,
    identity_min: 0.80,
    description: 'Standard player character'
  },
  boss: {
    target_size: 256,
    frame_count: 12,
    identity_min: 0.75,  // Slightly relaxed for larger sprites
    description: 'Boss characters with more detail'
  },
  npc: {
    target_size: 128,
    frame_count: 4,
    identity_min: 0.85,  // Stricter for simpler designs
    description: 'Simple NPCs with fewer frames'
  }
};
```

### Template Engine

```typescript
async function generateManifest(
  character: string,
  move: string,
  preset: keyof typeof PRESETS = 'champion'
): Promise<string> {
  const template = await fs.readFile(MANIFEST_TEMPLATE_PATH, 'utf-8');
  const presetValues = PRESETS[preset];

  const replacements: Record<string, string> = {
    '{{CHARACTER}}': character.toUpperCase(),
    '{{CHARACTER_LOWER}}': character.toLowerCase(),
    '{{MOVE}}': move.toLowerCase(),
    '{{DATE}}': new Date().toISOString().split('T')[0],
    '{{TARGET_SIZE}}': presetValues.target_size.toString(),
    '{{FRAME_COUNT}}': presetValues.frame_count.toString()
  };

  let result = template;
  for (const [placeholder, value] of Object.entries(replacements)) {
    result = result.replaceAll(placeholder, value);
  }

  return result;
}
```

### CLI Output

```
üìù Creating manifest for NOVA - attack

Using preset: champion (128px, 8 frames)

Generated: manifests/nova-attack.yaml

Next steps:
  1. Update asset paths in the manifest
  2. Create prompt templates in assets/prompts/nova/
  3. Run: pipeline run manifests/nova-attack.yaml
```

### Project Structure Notes

- New: `src/commands/pipeline/new-manifest.ts`
- New: `assets/templates/manifest.yaml.template`
- Tests: `test/commands/pipeline/new-manifest.test.ts`

### References

- [Source: _bmad-output/planning-artifacts/epics.md#Story 6.5]

---

## Dev Agent Record

### Agent Model Used

**Claude Opus 4.5**

**Rationale:** Template file generation with placeholders. Well-defined replacement logic. Straightforward CLI command.

### Debug Log References

- Initial implementation created template that didn't match actual Zod schema
- Fixed template to use `hard_gates`, `soft_metrics`, and `ladder` array structure matching manifestSchema
- Fixed test assertions to match template field names (SF01_IDENTITY_DRIFT vs identity_min)

### Completion Notes List

- Created `new-manifest` CLI command with Commander.js
- Implemented 3 presets: champion (128px, 8 frames), boss (256px, 12 frames), npc (128px, 4 frames)
- Template includes comprehensive inline comments explaining each field
- Generated manifests pass Zod schema validation
- Name validation: must start with letter, alphanumeric + underscore/hyphen, max 32 chars
- Sanitization: lowercase, hyphens converted to underscores
- 27 tests covering presets, validation, sanitization, path generation, template replacement, manifest generation

### File List

- `src/commands/new-manifest.ts` - CLI command implementation
- `assets/templates/manifest.yaml.template` - YAML template with placeholders
- `test/commands/new-manifest.test.ts` - Unit tests (27 tests)
- `src/bin.ts` - Added registerNewManifestCommand
